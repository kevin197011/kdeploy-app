#!/bin/bash
# Backup script for <%= app_name %>

set -e

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="<%= backup_dir %>"
DB_NAME="<%= db_name %>"
APP_ROOT="/var/www/<%= app_name %>"

echo "Starting backup for <%= app_name %>"

# Create backup directory
mkdir -p $BACKUP_DIR

# Backup database
echo "Backing up database..."
pg_dump -U <%= db_user %> $DB_NAME > $BACKUP_DIR/${DB_NAME}_${TIMESTAMP}.sql
gzip $BACKUP_DIR/${DB_NAME}_${TIMESTAMP}.sql

# Backup uploads
echo "Backing up uploads..."
tar -czf $BACKUP_DIR/uploads_${TIMESTAMP}.tar.gz $APP_ROOT/shared/public/uploads

# Backup configuration
echo "Backing up configuration..."
tar -czf $BACKUP_DIR/config_${TIMESTAMP}.tar.gz $APP_ROOT/shared/config

# Cleanup old backups
echo "Cleaning up old backups..."
find $BACKUP_DIR -name "*.sql.gz" -mtime +<%= keep_days %> -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +<%= keep_days %> -delete

echo "Backup completed successfully!"
